/*
Copyright © 2013 Adobe Systems Incorporated.

Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*//**
 * See <a href="http://jquery.com">http://jquery.com</a>.
 * @name jquery
 * @class
 * See the jQuery Library  (<a href="http://jquery.com">http://jquery.com</a>) for full details.  This just
 * documents the function and classes that are added to jQuery by this plug-in.
 *//**
 * See <a href="http://jquery.com">http://jquery.com</a>
 * @name fn
 * @class
 * See the jQuery Library  (<a href="http://jquery.com">http://jquery.com</a>) for full details.  This just
 * documents the function and classes that are added to jQuery by this plug-in.
 * @memberOf jquery
 *//**
 * @fileOverview accessibleMegaMenu plugin
 *
 *<p>Licensed under the Apache License, Version 2.0 (the “License”)
 *<br />Copyright © 2013 Adobe Systems Incorporated.
 *<br />Project page <a href="https://github.com/adobe-accessibility/Accessible-Mega-Menu">https://github.com/adobe-accessibility/Accessible-Mega-Menu</a>
 * @version 0.1
 * @author Michael Jordan
 * @requires jquery
 *//*jslint browser: true, devel: true, plusplus: true, nomen: true *//*global jQuery */(function(e,t,n){"use strict";function o(t,n){this.element=t;this.settings=e.extend({},i,n);this._defaults=i;this._name=r;this.init()}function u(t){return e.expr.filters.visible(t)&&!e(t).parents().addBack().filter(function(){return e.css(this,"visibility")==="hidden"}).length}function a(t,n){var r,i,s,o=t.nodeName.toLowerCase();if("area"===o){r=t.parentNode;i=r.name;if(!t.href||!i||r.nodeName.toLowerCase()!=="map")return!1;s=e("img[usemap=#"+i+"]")[0];return!!s&&u(s)}return(/input|select|textarea|button|object/.test(o)?!t.disabled:"a"===o?t.href||n:n)&&u(t)}var r="accessibleMegaMenu",i={uuidPrefix:"accessible-megamenu",menuClass:"accessible-megamenu",topNavItemClass:"accessible-megamenu-top-nav-item",panelClass:"accessible-megamenu-panel",panelGroupClass:"accessible-megamenu-panel-group",hoverClass:"hover",focusClass:"focus",openClass:"open"},s={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38,keyMap:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",190:"."}};o.prototype=function(){var i=0,u=1e3,a="",f=typeof t.hasOwnProperty=="function"&&!!t.hasOwnProperty("ontouchstart"),l,c,h,p,d,v,m,g,y,b,w,E,S;l=function(t){return e(t).closest(":data(plugin_"+r+")").data("plugin_"+r)};c=function(t){t=e(t);var n=this.settings;t.attr("id")||t.attr("id",n.uuidPrefix+"-"+(new Date).getTime()+"-"+ ++i)};h=function(t,r){var i=e(t.target),o=this,u=this.settings,a=this.menu,f=i.closest("."+u.topNavItemClass),l=i.hasClass(u.panelClass)?i:i.closest("."+u.panelClass),c;S.call(this,r);e("html").off("mouseup.outside-accessible-megamenu, touchend.outside-accessible-megamenu, mspointerup.outside-accessible-megamenu, pointerup.outside-accessible-megamenu",d);a.find("[aria-expanded]."+this.settings.panelClass).off("DOMAttrModified.accessible-megamenu");if(r){f=a.find("."+u.topNavItemClass+" ."+u.openClass+":first").closest("."+u.topNavItemClass);if(!(f.is(t.relatedTarget)||f.has(t.relatedTarget).length>0)){if((t.type==="mouseout"||t.type==="focusout")&&f.has(n.activeElement).length>0)return;f.find("[aria-expanded]").attr("aria-expanded","false").removeClass(u.openClass).filter("."+u.panelClass).attr("aria-hidden","true");if(t.type==="keydown"&&t.keyCode===s.ESCAPE||t.type==="DOMAttrModified"){c=f.find(":tabbable:first");setTimeout(function(){a.find("[aria-expanded]."+o.settings.panelClass).off("DOMAttrModified.accessible-megamenu");c.focus();o.justFocused=!1},99)}}else f.length===0&&a.find("[aria-expanded=true]").attr("aria-expanded","false").removeClass(u.openClass).filter("."+u.panelClass).attr("aria-hidden","true")}else{clearTimeout(o.focusTimeoutID);f.siblings().find("[aria-expanded]").attr("aria-expanded","false").removeClass(u.openClass).filter("."+u.panelClass).attr("aria-hidden","true");f.find("[aria-expanded]").attr("aria-expanded","true").addClass(u.openClass).filter("."+u.panelClass).attr("aria-hidden","false");if(t.type==="mouseover"&&i.is(":tabbable")&&f.length===1&&l.length===0&&a.has(n.activeElement).length>0){i.focus();o.justFocused=!1}S.call(o)}};p=function(t){var n=e(t.target),r=n.closest("."+this.settings.topNavItemClass),i=n.closest("."+this.settings.panelClass);if(r.length===1&&i.length===0&&r.find("."+this.settings.panelClass).length===1)if(!n.hasClass(this.settings.openClass)){t.preventDefault();t.stopPropagation();h.call(this,t)}else if(this.justFocused){t.preventDefault();t.stopPropagation();this.justFocused=!1}else if(f){t.preventDefault();t.stopPropagation();h.call(this,t,n.hasClass(this.settings.openClass))}};d=function(t){if(this.menu.has(e(t.target)).length===0){t.preventDefault();t.stopPropagation();h.call(this,t,!0)}};v=function(t){if(t.originalEvent.attrName==="aria-expanded"&&t.originalEvent.newValue==="false"&&e(t.target).hasClass(this.settings.openClass)){t.preventDefault();t.stopPropagation();h.call(this,t,!0)}};m=function(t){clearTimeout(this.focusTimeoutID);e(t.target).addClass(this.settings.focusClass).on("click.accessible-megamenu",e.proxy(p,this));this.justFocused=!0;this.panels.filter("."+this.settings.openClass).length&&h.call(this,t)};g=function(n){this.justFocused=!1;var r=this,i=e(n.target),s=i.closest("."+this.settings.topNavItemClass),o=!1;i.removeClass(this.settings.focusClass).off("click.accessible-megamenu",p);t.cvox?r.focusTimeoutID=setTimeout(function(){t.cvox.Api.getCurrentNode(function(e){s.has(e).length?clearTimeout(r.focusTimeoutID):r.focusTimeoutID=setTimeout(function(e,t,n){h.call(e,t,n)},275,r,n,!0)})},25):r.focusTimeoutID=setTimeout(function(){h.call(r,n,!0)},300)};y=function(n){var r=e(e(this).is(".hover:tabbable")?this:n.target),i=r.is(n.target)?this:l(r),o=i.settings,f=i.menu,c=i.topnavitems,d=r.closest("."+o.topNavItemClass),v=f.find(":tabbable"),m=r.hasClass(o.panelClass)?r:r.closest("."+o.panelClass),g=m.find("."+o.panelGroupClass),y=r.closest("."+o.panelGroupClass),b,w=n.keyCode||n.which,E,S,x,T,N=!1,C=s.keyMap[n.keyCode]||"",k,L=d.length===1&&m.length===0;r.is(".hover:tabbable")&&e("html").off("keydown.accessible-megamenu");switch(w){case s.ESCAPE:h.call(i,n,!0);break;case s.DOWN:n.preventDefault();if(L){h.call(i,n);N=d.find("."+o.panelClass+" :tabbable:first").focus().length===1}else N=v.filter(":gt("+v.index(r)+"):first").focus().length===1;if(!N&&t.opera&&opera.toString()==="[object Opera]"&&(n.ctrlKey||n.metaKey)){v=e(":tabbable");S=v.index(r);N=e(":tabbable:gt("+e(":tabbable").index(r)+"):first").focus().length===1}break;case s.UP:n.preventDefault();if(L&&r.hasClass(o.openClass)){h.call(i,n,!0);b=c.filter(":lt("+c.index(d)+"):last");b.children("."+o.panelClass).length&&(N=b.children().attr("aria-expanded","true").addClass(o.openClass).filter("."+o.panelClass).attr("aria-hidden","false").find(":tabbable:last").focus()===1)}else L||(N=v.filter(":lt("+v.index(r)+"):last").focus().length===1);if(!N&&t.opera&&opera.toString()==="[object Opera]"&&(n.ctrlKey||n.metaKey)){v=e(":tabbable");S=v.index(r);N=e(":tabbable:lt("+e(":tabbable").index(r)+"):first").focus().length===1}break;case s.RIGHT:n.preventDefault();if(L)N=c.filter(":gt("+c.index(d)+"):first").find(":tabbable:first").focus().length===1;else{g.length&&y.length&&(N=g.filter(":gt("+g.index(y)+"):first").find(":tabbable:first").focus().length===1);N||(N=d.find(":tabbable:first").focus().length===1)}break;case s.LEFT:n.preventDefault();if(L)N=c.filter(":lt("+c.index(d)+"):last").find(":tabbable:first").focus().length===1;else{g.length&&y.length&&(N=g.filter(":lt("+g.index(y)+"):last").find(":tabbable:first").focus().length===1);N||(N=d.find(":tabbable:first").focus().length===1)}break;case s.TAB:S=v.index(r);if(n.shiftKey&&L&&r.hasClass(o.openClass)){h(n,!0);b=c.filter(":lt("+c.index(d)+"):last");b.children("."+o.panelClass).length&&(N=b.children().attr("aria-expanded","true").addClass(o.openClass).filter("."+o.panelClass).attr("aria-hidden","false").find(":tabbable:last").focus())}else if(n.shiftKey&&S>0)N=v.filter(":lt("+S+"):last").focus().length===1;else if(!n.shiftKey&&S<v.length-1)N=v.filter(":gt("+S+"):first").focus().length===1;else if(t.opera&&opera.toString()==="[object Opera]"){v=e(":tabbable");S=v.index(r);n.shiftKey?N=e(":tabbable:lt("+e(":tabbable").index(r)+"):last").focus().length===1:N=e(":tabbable:gt("+e(":tabbable").index(r)+"):first").focus().length===1}N&&n.preventDefault();break;case s.SPACE:if(L){n.preventDefault();p.call(i,n)}break;default:clearTimeout(this.keydownTimeoutID);a+=C!==a?C:"";if(a.length===0)return;this.keydownTimeoutID=setTimeout(function(){a=""},u);L&&!r.hasClass(o.openClass)?v=v.filter("."+o.topNavItemClass+" > :tabbable"):v=d.find(":tabbable");n.shiftKey&&(v=e(v.get().reverse()));for(S=0;S<v.length;S++){x=v.eq(S);if(x.is(r)){E=a.length===1?S+1:S;break}}k=new RegExp("^"+a.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"),"i");for(S=E;S<v.length;S++){x=v.eq(S);T=e.trim(x.text());if(k.test(T)){N=!0;x.focus();break}}if(!N)for(S=0;S<E;S++){x=v.eq(S);T=e.trim(x.text());if(k.test(T)){x.focus();break}}}i.justFocused=!1};b=function(e){this.mouseTimeoutID=setTimeout(function(){clearTimeout(this.focusTimeoutID)},1)};w=function(t){clearTimeout(this.mouseTimeoutID);e(t.target).addClass(this.settings.hoverClass);h.call(this,t);e(t.target).is(":tabbable")&&e("html").on("keydown.accessible-megamenu",e.proxy(y,t.target))};E=function(t){var n=this;e(t.target).removeClass(n.settings.hoverClass);n.mouseTimeoutID=setTimeout(function(){h.call(n,t,!0)},250);e(t.target).is(":tabbable")&&e("html").off("keydown.accessible-megamenu")};S=function(t){var n=this.menu;if(t){e("html").off("mouseup.outside-accessible-megamenu, touchend.outside-accessible-megamenu, mspointerup.outside-accessible-megamenu,  pointerup.outside-accessible-megamenu",d);n.find("[aria-expanded]."+this.settings.panelClass).off("DOMAttrModified.accessible-megamenu",v)}else{e("html").on("mouseup.outside-accessible-megamenu, touchend.outside-accessible-megamenu, mspointerup.outside-accessible-megamenu,  pointerup.outside-accessible-megamenu",e.proxy(d,this));n.find("[aria-expanded=true]."+this.settings.panelClass).on("DOMAttrModified.accessible-megamenu",e.proxy(v,this))}};return{constructor:o,init:function(){var t=this,n=this.settings,r=this.justFocused=!1,i=this.nav=e(this.element),s=this.menu=i.children().first(),o=this.topnavitems=s.children();i.attr("role","navigation");s.addClass(n.menuClass);o.each(function(r,i){var s,o;i=e(i);i.addClass(n.topNavItemClass);s=i.find(":tabbable:first");o=i.children(":not(:tabbable):last");c.call(t,s);if(o.length){c.call(t,o);s.attr({"aria-haspopup":!0,"aria-owns":o.attr("id"),"aria-controls":o.attr("id"),"aria-expanded":!1});o.attr({role:"group","aria-expanded":!1,"aria-hidden":!0}).addClass(n.panelClass).not("[aria-labelledby]").attr("aria-labelledby",s.attr("id"))}});this.panels=s.find("."+n.panelClass);s.on("focusin.accessible-megamenu",":tabbable, :focusable, ."+n.panelClass,e.proxy(m,this)).on("focusout.accessible-megamenu",":tabbable, :focusable, ."+n.panelClass,e.proxy(g,this)).on("keydown.accessible-megamenu",e.proxy(y,this)).on("mouseover.accessible-megamenu",e.proxy(w,this)).on("mouseout.accessible-megamenu",e.proxy(E,this)).on("mousedown.accessible-megamenu",e.proxy(b,this));f&&s.on("touchstart.accessible-megamenu",e.proxy(p,this));s.find("hr").attr("role","separator")},getDefaults:function(){return this._defaults},getOption:function(e){return this.settings[e]},getAllOptions:function(){return this.settings},setOption:function(e,t,n){this.settings[e]=t;n&&this.init()}}}();e.fn[r]=function(t){return this.each(function(){e.data(this,"plugin_"+r)||e.data(this,"plugin_"+r,new o(this,t))})};e.extend(e.expr[":"],{data:e.expr.createPseudo?e.expr.createPseudo(function(t){return function(n){return!!e.data(n,t)}}):function(t,n,r){return!!e.data(t,r[3])},focusable:function(t){return a(t,!isNaN(e.attr(t,"tabindex")))},tabbable:function(t){var n=e.attr(t,"tabindex"),r=isNaN(n);return(r||n>=0)&&a(t,!r)}})})(jQuery,window,document);